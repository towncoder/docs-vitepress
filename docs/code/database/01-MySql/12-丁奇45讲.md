## 第一讲 一条SQL查询语句是如何执行的

- MySql 架构：连接器、分析器、优化器、执行器、存储引擎
- 一个用户成功建立连接后，即使你用管理员账号对这个用户的权限做了修改，也不会影响已经存在连接的权限。修改完成后，只有再新建的连接才会使用新的权限设置。
- 建立连接后长时间没有命令，就会断开，默认 8 小时，而简历链接是比较耗时的，所以需要数据库连接池。
- 查询缓存的失效非常频繁，只要有对一个表的更新，这个表上所有的查询缓存都会被清空。**所以不建议使用缓存**。

```sql
-- 将参数query_cache_type设置成DEMAND，这样对于默认的SQL语句都不使用查询缓存
-- 显示指定缓存
-- 8 以上缓存功能已彻底删除
select SQL_CACHE * from T where ID=10；
```

- 在分析阶段判断语句是否正确，表是否存在，列是否存在等。

## 第二讲 一条SQL更新语句是如何执行的

- WAL技术，WAL的全称是Write-Ahead Logging，它的关键点就是先写日志 redo log（重做日志）和 binlog（归档日志），再写磁盘。
- 两种日志有以下三点不同。
  - redo log是InnoDB引擎特有的；binlog是MySQL的Server层实现的，所有引擎都可以使用。
  - redo log是物理日志，记录的是“在某个数据页上做了什么修改”；binlog是逻辑日志，记录的是这个语句的原始逻辑，比如“给ID=2这一行的c字段加1 ”。
  - redo log是循环写的，空间固定会用完；binlog是可以追加写入的。“追加写”是指binlog文件写到一定大小后会切换到下一个，并不会覆盖以前的日志。

- write pos是当前记录的位置，一边写一边后移，写到第3号文件末尾后就回到0号文件开头。checkpoint是当前要擦除的位置，也是往后推移并且循环的，擦除记录前要把记录更新到数据文件。

  write pos和checkpoint之间的是“粉板”上还空着的部分，可以用来记录新的操作。如果write pos追上checkpoint，表示“粉板”满了，这时候不能再执行新的更新，得停下来先擦掉一些记录，把checkpoint推进一下。

  保证即使数据库发生异常重启，之前提交的记录都不会丢失，这个能力称为crash-safe。

![](https://yitiaoit.oss-cn-beijing.aliyuncs.com/img/20230905175707.png)

- 