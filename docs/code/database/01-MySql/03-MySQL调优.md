SQL优化那点事儿

大家好，我是一条，一个梦想弃码从文的程序员。

上篇文章，我们聊了如何看懂MySQL的执行计划，不知道大家还记得多少，忘了的赶紧去复习一下。

本篇文章开始上正菜，聊聊SQL优化那点事。

总的来说，优化方向有以下几点：

1. 数据库设计优化
2. 索引优化
3. sql查询优化
4. 分库分表优化
5. 集群架构优化
6. 服务配置优化

我们由浅入深，本文先讲前三种优化方向。话不多说，开干。

## 数据库设计优化

>说白了就是表怎么建，即使最简单的crud，表建的不好，写起来也是贼恶心，接口超时也是经常发生。
>
>经济基础决定上层建筑，但是在实际开发中，建表一般都由组长完成，少了很多练手的机会，所以就拿出来和大家聊聊。

### 逻辑设计

三范式

工具

### 物理设计



#### 数据类型

- 整数：`tinyint、int、bigint`

  选择格式的类型，`int(2)`是没有用的

- 实数：`float、double、decimal`

  精度

- 字符串

  

- 时间：`datatime、timestamp`

  时区、范围

- 日期：`data、time`

timestamp 

1970-01-01~2038-01-19



实例数据库库下载：https://downloads.mysql.com/docs/sakila-db.zip 

   

## Tips

>- 优化更需要优化的sql
>- 定位性能瓶颈
>- 用explain查看执行计划
>
>
>
>- 永远用小结果集驱动大结果集
>
>大于百万级别的表不适用于join。
>
>什么是驱动表：筛选出的行数少的表
>
>Nest Loop join 循环嵌套算法
>
>减少外层循环的次数
>
>内层增加索引
>
>增大 join buffer
>
>- 禁用复杂的join和子查询
>- 尽可能在索引中排序
>- 慎用order by、group by、distinct
>- 只取自己需要的列
>- 使用最有效的过滤条件
>- 合理设计并使用索引，避免失效
>
>



![](https://yitiaoit.oss-cn-beijing.aliyuncs.com/img/20230831154320.png)

## join 优化

> join 优化仅限于百万以下的表，目前实际开发一个表的数据很容易就超过百万，所以都强制单表查询，所以实际用到的不多，但需要了解。

### 优化思路

总结一句话：**小结果集驱动大结果集**。

- 结果集：满足查询条件的记录行数。
- 驱动表：主表，内连接时由 Mysql  的优化器自主选择，这个会收到联接字段上的索引的影响，因为主表需要按行扫描，索引就无意义，所以不会选择有索引的表作为驱动表。

### join 算法

循环嵌套联接算法：





### join buffer

默认 256 k，诞生于 MySQL 8 以后，通过缓存区一次性读多条数据进行遍历。

```sql
-- 设置 buffer 大小

```





## order by 分组优化



## group by 分组优化

分组优化的思路：

```sql
select @@version;
```





# 

## 怎样避免写出慢sql

https://b.geekbang.org/member/course/detail/211555

**定量认识 MySQL**

理论上一台 MySQL 数据库，大致处理能力的极限是，每秒一万条左右的简单 SQL，这里的“简单 SQL”，指的是类似于主键查询这种不需要遍历很多条记录的 SQL。根据服务器的配置高低，实际的 TPS 还要上下浮动。

实际生产，一般一台 MySQL 服务器，平均每秒钟执行的 SQL 数量在几百左右，就已经是非常繁忙了，即使看起来 CPU 利用率和磁盘繁忙程度没那么高，你也需要考虑给数据库“减负”了。

到底多慢的 SQL 才算慢 SQL？

你在编写一条查询语句的时候，可以依据你要查询数据表的数据总量，估算一下这条查询大致需要遍历多少行数据。如果遍历行数在百万以内的，只要不是每秒钟都要执行几十上百次的频繁查询，可以认为是安全的。

遍历数据行数在几百万的，查询时间最少也要几秒钟，你就要仔细考虑有没有优化的办法。

遍历行数达到千万量级和以上的，我只能告诉你，这种查询就不应该出现在你的系统中。当然我们这里说的都是在线交易系统，离线分析类系统另说。

**分析 SQL 执行计划**



## 企业开发规范

**命名规范**

数据库，表，字段名采用小写字母，数字，下划线，名称必须具有实际意义

数据库，表，字段名不允许使用MySQL关键字

数据库，表，字段名长度不超过30个字符

临时表以tmp_表名_日期命名

备份表以bak_表名_日期命名

索引名必须以idx_字段名命名，唯一索引以uk_字段名命名，联合索引多个字段以"_"分割

主键字段名必须为id

不同MySQL实例的数据库名不能相同（不包含系统库）

不同表中存储相同数据的字段名和类型必须一致

数据库名称应该能区分不同环境

**设计规范**

使用innodb存储引擎

使用utf8mb4字符集，字符集在实例级设置，创建库、表不需要指定字符集

表必须有主键，主键字段名称id，数据类型int，自增，不允许联合主键

表，字段必须有注释

所有字段建议设置not null

使用varchar存储字符类型数据，长度建议不超过500

使用datetime存储日期时间类型数据

使用decimal或int存储金额类数据，不允许使用double或float

不建议使用text/blob类型，如确有需求，应单独建立扩展表

不允许使用ENUM类型

不允许使用外键

不允许建立预留字段

不允许使用视图，存储过程，触发器等

不建议使用唯一索引，由程序保证唯一性

不建议使用分区表，使用水平分表方式替代

建议单个实例库数量不超过10个（不包含系统库）

建议单个库表数量不超过200

建议单张表字段数不超过50

建议单张表上索引数量不超过6个，联合索引不超过4个字段

避免冗余索引，重复索引

频繁更新的列不建议建立索引

连接不同库要使用不同账号，禁止跨库权限

数据库账号一般只赋予select，update，insert，delete权限

**操作规范**

禁止select *，必须指定字段

禁止insert select 方式

insert语句必须带有字段列表

禁止不带where条件的select，update，delete，where条件字段必须有索引，建议通过主键id进行操作

不允许3张表以上的join

join字段必须有索引

禁止like '%%' 模糊查询

不允许使用存储过程

where条件中字段不允许使用表达式或函数，避免索引失效

where条件中=两端数据类型必须一直，避免隐式转换

避免大事务操作，每个事务更新行数限制在200行以内

避免使用不等于、not

union all代替union

同一列使用in替代or，in操作的数值不超过200个

非必要不使用order by，排序字段应有索引

使用join替代子查询

拆分复杂大SQL为多个小SQL

禁止线下连接线上数据库
禁止程序代码中运行ddl
禁止在数据库中存储明文密码
数据库只负责存取数据，禁止数据库中处理业务逻辑

## 如何优化超大的分页查询

https://zhuanlan.zhihu.com/p/279863859



## 批量插入

```properties
rewriteBatchedStatements=true  
# JDBC 会将尽可能多的查询打包到单个网络数据包中，从而降低网络开销。

# 举例
jdbc:mysql://数据库地址/数据库名?useUnicode=true&characterEncoding=UTF8&allowMultiQueries=true&rewriteBatchedStatements=true
```

## 分组查询 group by



## 排序 order by

