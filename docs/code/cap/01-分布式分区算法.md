## 分布式存储分区解决方案

现有3万张图片，希望均匀分布放到3台服务器上，访问时可以通过编号计算出服务器。

## 普通的哈希算法（取余）

首先对图片名称进行哈希计算得出哈希值，再将将哈希值对3取余，根据余数0,1,2放入对应服务器，访问图片时也可以通过取余计算出对应服务器。

![](https://yitiaoit.oss-cn-beijing.aliyuncs.com/img/image-20230129154025357.png)

问题是：如果此时增加一台服务器，那么一张图片所在的服务器编号必定与原来3台服务器时所在的服务器编号不同，因为除数由3变为了4，最终导致所有存放的位置都要发生改变。

## 一致性哈希算法

> 一致性哈希算法在1997年由麻省理工学院提出，是一种特殊的哈希算法。
>
> 目的是解决在移除或者添加一个服务器时，能够尽可能小地改变已存在的服务请求与处理请求服务器之间的`映射关系`，解决了简单哈希算法在分布式哈希表中存在的动态伸缩等问题。

一致性哈希算法的改进在于不是对服务器的数量进行取模，而对`2^32`（4294967296）取模，具体步骤如下：

- 一致性哈希算法将整个哈希值空间`[0,2^32-1]`按照顺时针方向组织成一个虚拟的圆环，称为 Hash 环。
- 接着将各个服务器使用 Hash 函数进行哈希，具体可以选择服务器的IP或主机名作为关键字进行哈希，从而确定每台机器在哈希环上的位置。
- 最后使用算法定位数据访问到相应服务器：将数据key（图片名称）使用相同的Hash函数计算出哈希值，并确定此数据在环上的位置，`从此位置沿环顺时针寻找，第一台遇到的服务器就是其应该定位到的服务器`。

![](https://yitiaoit.oss-cn-beijing.aliyuncs.com/img/image-20230129155505767.png)

**如何解决动态伸缩问题**

假设此时B服务器故障，只需要把3移到c服务器上，其他图片存放的位置不会有变化，增加服务器同理。

**数据倾斜**

一致性哈希算法在服务节点太少的情况下，容易因为节点分部不均匀而造成数据倾斜问题，也就是被缓存的对象大部分集中缓存在某一台服务器上，从而出现数据分布不均匀的情况，这种情况就称为 hash 环的倾斜。

![](https://yitiaoit.oss-cn-beijing.aliyuncs.com/img/image-20230129164422325.png)

**虚拟节点**

意在解决数据倾斜的问题，即对每一个服务节点计算多个哈希，每个计算结果位置都放置一个此服务节点，称为虚拟节点。

一个实际物理节点可以对应多个虚拟节点，虚拟节点越多，hash环上的节点就越多，缓存被均匀分布的概率就越大，hash环倾斜所带来的影响就越小。

同时数据定位算法不变，只是多了一步虚拟节点到实际节点的映射。具体做法可以在服务器ip或主机名的后面增加编号来实现，加入虚拟节点以后的hash环如下：

![](https://yitiaoit.oss-cn-beijing.aliyuncs.com/img/image-20230129164712710.png)

## 哈希槽算法

> 解决一致性哈希算法的数据倾斜问题。
>
> 哈希槽实质就是一个数组，数组`[0,2^14-1]`形成hash slot空间。（2^14=16384）

相比于上面，在数据和节点之间又加入了一层，把这层称为哈希槽（slot），用于管理数据和节点之间的关系，现在就相当于节点上放的是槽，槽里放的是数据。

![](https://yitiaoit.oss-cn-beijing.aliyuncs.com/img/image-20230129165325775.png)

槽解决的是粒度问题，相当于把粒度变大了，这样便于数据移动。哈希解决的是映射问题，使用key的哈希值来计算所在的槽，便于数据分配。

一个集群16384个槽，分配给不同的节点，分配策略随意，可以指定哪些编号的槽分配给哪个主节点，集群会记录节点和槽的对应关系。

接下来就需要对key求哈希值，然后对16384取余，余数是几key就落入对应的槽里。`slot = CRC16(key) % 16384`。以槽为单位移动数据，因为槽的数目是固定的，处理起来比较容易，这样数据移动问题就解决了。

![](https://yitiaoit.oss-cn-beijing.aliyuncs.com/img/image-20230129171218601.png)



**Redis槽位为什么是16384个**

slot总共有16384个，这个数字是由redis的作者给定的一个比较合理的数据，crc16算法产生的哈希值有16bit，也就是说有2^16=65536个值。

但是为什么只取了16384个槽？因为redis集群的设计是节点间会相互ping-pong通信，那就会有消息产生，槽位、节点数越大，通信需要携带的数据也就越大，而节点至少每秒会发送一次ping消息，网络资源负荷就很高。

16384/8=2048=2KB空间。而如果是65536个slot，即65536位，占用空间为65536/8=8KB；16384个slot占用的空间更少；

实际场景中的redis节点数据不会超过1000个，而节点数据小于1000的时候，16384个槽位足够使用了。

简单来说，16384个slot占用空间更少；对于最多1000个master的redis集群来说，也完全够用。所以规定为16384个slot，而不是65536个。

##  代码实现

https://juejin.cn/post/7275533017295798333